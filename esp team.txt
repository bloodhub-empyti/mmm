local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ESPEnabled = true

local function CreateESP(character, player)
    if character:FindFirstChild("TeamESPFolder") then return end
    
    local hrp = character:WaitForChild("HumanoidRootPart", 5)
    if not hrp then return end
    
    local folder = Instance.new("Folder")
    folder.Name = "TeamESPFolder"
    folder.Parent = character

    -- ===== BOX =====
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Box"
    box.Adornee = hrp
    box.Size = Vector3.new(4,6,2)
    box.Color3 = player.TeamColor.Color
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Transparency = 0.4
    box.Parent = folder

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "Distance"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 100, 0, 20)
    billboard.StudsOffset = Vector3.new(0, 3.5, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = folder

    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1,0,1,0)
    text.BackgroundTransparency = 1
    text.TextScaled = false
    text.TextSize = 14 -- nhỏ vừa đủ nhìn
    text.Font = Enum.Font.Gotham
    text.TextStrokeTransparency = 0
    text.TextColor3 = player.TeamColor.Color
    text.Parent = billboard

    task.spawn(function()
        while character.Parent and ESPEnabled do
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local myPos = LocalPlayer.Character.HumanoidRootPart.Position
                local targetPos = hrp.Position
                local distance = (myPos - targetPos).Magnitude
                text.Text = math.floor(distance) .. "m"
            end
            task.wait(0.1)
        end
    end)
end

local function RemoveESP(character)
    if character and character:FindFirstChild("TeamESPFolder") then
        character.TeamESPFolder:Destroy()
    end
end

local function SetupPlayer(player)
    if player == LocalPlayer then return end

    local function Apply(character)
        if not ESPEnabled then return end
        CreateESP(character, player)
    end

    if player.Character then
        Apply(player.Character)
    end

    player.CharacterAdded:Connect(function(character)
        task.wait(1)
        Apply(character)
    end)
end

Players.PlayerAdded:Connect(SetupPlayer)

Players.PlayerRemoving:Connect(function(player)
    if player.Character then
        RemoveESP(player.Character)
    end
end)

for _, player in pairs(Players:GetPlayers()) do
    SetupPlayer(player)
end
